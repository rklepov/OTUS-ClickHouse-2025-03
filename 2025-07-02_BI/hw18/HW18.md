# [18] Визуализация данных

> Я работаю локально через [VirtualBox](https://www.virtualbox.org/) на Linux [CentOS 9](https://www.centos.org/stream9/).

## Архитектура решения

*Apache Superset* и *ClickHouse* запускаются в *Docker* контейнерах.

<details>

<summary>docker-compose.yaml</summary>

```yaml
version: "3.8"

services:
  superset:
    image: apache/superset:latest
    restart: always
    hostname: superset
    networks:
      - net
    volumes:
      - superset_home:/app/superset_home
    environment:
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY}
    ports:
      - "0.0.0.0:8080:8088"

  clickhouse:
    image: "clickhouse/clickhouse-server:latest"
    user: "0:0"
    hostname: clickhouse
    networks:
      - net
    volumes:
      - clickhouse_vol:/var/lib/clickhouse
      - ${PWD}/fs/volumes/import:/import:Z
      - ${PWD}/fs/volumes/clickhouse/etc/clickhouse-server/config.d/config.xml:/etc/clickhouse-server/config.d/config.xml:Z
      - ${PWD}/fs/volumes/clickhouse/etc/clickhouse-server/users.d/users.xml:/etc/clickhouse-server/users.d/users.xml:Z
    ports:
      - "0.0.0.0:18123:8123"
      - "0.0.0.0:19000:9000"

volumes:
  superset_home:
  clickhouse_vol:

networks:
  net:
    driver: bridge
```

</details>

Все файлы конфигурации можно найти в текущем [репозитории](https://github.com/rklepov/OTUS-ClickHouse-2025-03/tree/main/2025-07-02_BI/hw18).

Запустим контейнеры с *Superset* и *ClickHouse* c помощью команды `docker compose up -d`.

```shell
$ docker ps

CONTAINER ID  IMAGE                                          COMMAND               CREATED         STATUS         PORTS                                                       NAMES
e0e890fe3a02  docker.io/apache/superset:latest               /usr/bin/run-serv...  17 seconds ago  Up 13 seconds  0.0.0.0:8080->8088/tcp                                      hw18_superset_1
36d0fc75319f  docker.io/clickhouse/clickhouse-server:latest                        8 seconds ago   Up 6 seconds   0.0.0.0:18123->8123/tcp, 0.0.0.0:19000->9000/tcp, 9009/tcp  hw18_clickhouse_1
```

## Настройка *Superset*

Проведём настройку *Superset* в соответствии с [инструкцией](https://github.com/AlexeyFerum/teaching_time/wiki/Superset-init-tutorial).

Переходим в контейнер.

```shell
$ docker exec -it hw18_superset_1 bash

superset@superset:/app$ superset version
-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
Superset 4.1.3
-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
```

Обновляем БД.

```shell
superset@superset:/app$ superset db upgrade

INFO  [alembic.env] Starting the migration scripts.
.  .  .  .  .
INFO  [alembic.env] Migration scripts completed. Duration: 00:00:35
```

Выполняем инициализацию.

```shell
superset@superset:/app$ superset init

2025-07-28 19:20:19,830:INFO:superset.security.manager:Syncing role definition
2025-07-28 19:20:21,708:INFO:superset.security.manager:Syncing Admin perms
.  .  .  .  .
```

Создаём пользователя.

```shell
superset@superset:/app$ superset fab create-admin \
          --username admin \
          --firstname Superset \
          --lastname Admin \
          --email <admin@superset.com> \
          --password admin
.  .  .  .  .

Recognized Database Authentications.
Admin User admin created.
```

Сразу установим библиотеку для работы с *ClickHouse*.

```shell
superset@superset:/app$ pip install clickhouse-connect
.  .  .  .  .

Successfully installed clickhouse-connect-0.8.18 lz4-4.4.4
```

После чего выходим из контейнера и перезапускаем его.

```shell
docker restart hw18_superset_1
```

Поскольку *ClickHouse* у нас уже параллельно работает в своём контейнере, то можно подключить его как источник, через меню `Settings -> Database Connections`.

![Superset ClickHouse connect](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/superset-clickhouse-connect.png)

## Данные в *ClickHouse*

В этой работе я буду использовать учебный датасет [New York Public Library "*What's on the Menu?*" Dataset](https://clickhouse.com/docs/getting-started/example-datasets/menus). Он содержит исторические данные по меню отелей, ресторанов, кафе, включающие наименования блюд и цены, начиная с середины XIX века.

Процесс загрузки данных подробно описан на странице датасета по ссылке выше, поэтому соответствующие действия здесь я приводить не буду.

В итоге у нас должна получиться одна сводная таблица **menu_item_denorm**.

<details>

<summary>menu_item_denorm</summary>

```sql
CREATE TABLE menu_item_denorm
(
    `price` Decimal(18, 3),
    `high_price` Decimal(18, 3),
    `created_at` DateTime,
    `updated_at` DateTime,
    `xpos` Float64,
    `ypos` Float64,
    `dish_id` UInt32,
    `dish_name` String,
    `dish_description` String,
    `dish_menus_appeared` UInt32,
    `dish_times_appeared` Int32,
    `dish_first_appeared` UInt16,
    `dish_last_appeared` UInt16,
    `dish_lowest_price` Decimal(18, 3),
    `dish_highest_price` Decimal(18, 3),
    `menu_id` UInt32,
    `menu_name` String,
    `menu_sponsor` String,
    `menu_event` String,
    `menu_venue` String,
    `menu_place` String,
    `menu_physical_description` String,
    `menu_occasion` String,
    `menu_notes` String,
    `menu_call_number` String,
    `menu_keywords` String,
    `menu_language` String,
    `menu_date` String,
    `menu_location` String,
    `menu_location_type` String,
    `menu_currency` String,
    `menu_currency_symbol` String,
    `menu_status` String,
    `menu_page_count` UInt16,
    `menu_dish_count` UInt16
)
ENGINE = MergeTree
ORDER BY (dish_name, created_at)
```

</details>

<a name="clickhouse-menu-averaged-historical-prices-of-dishes"></a>
На странице датасета также приводится пример запроса к данным в **menu_item_denorm**: средняя цена блюда в долларах за десятилетие.

```sql
SELECT
    round(toUInt32OrZero(extract(menu_date, '^\\d{4}')), -1) AS d,
    count(),
    round(avg(price), 2),
    bar(avg(price), 0, 100, 100)
FROM menu_item_denorm
WHERE (menu_currency = 'Dollars') AND (d > 0) AND (d < 2022)
GROUP BY d
ORDER BY d ASC

    ┌────d─┬─count()─┬─round(avg(price), 2)─┬─bar(avg(price), 0, 100, 100)─┐
 1. │ 1850 │     618 │                  1.5 │ █▍                           │
 2. │ 1860 │    1634 │                 1.29 │ █▎                           │
 3. │ 1870 │    2215 │                 1.36 │ █▎                           │
 4. │ 1880 │    3909 │                 1.01 │ █                            │
 5. │ 1890 │    8837 │                  1.4 │ █▍                           │
 6. │ 1900 │  176292 │                 0.68 │ ▋                            │
 7. │ 1910 │  212196 │                 0.88 │ ▉                            │
 8. │ 1920 │  179590 │                 0.74 │ ▋                            │
 9. │ 1930 │   73707 │                  0.6 │ ▌                            │
10. │ 1940 │   58795 │                 0.57 │ ▌                            │
11. │ 1950 │   41407 │                 0.95 │ ▉                            │
12. │ 1960 │   51179 │                 1.32 │ █▎                           │
13. │ 1970 │   12914 │                 1.86 │ █▊                           │
14. │ 1980 │    7268 │                 4.35 │ ████▎                        │
15. │ 1990 │   11055 │                 6.03 │ ██████                       │
16. │ 2000 │    2467 │                11.85 │ ███████████▊                 │
17. │ 2010 │     597 │                25.66 │ █████████████████████████▋   │
    └──────┴─────────┴──────────────────────┴──────────────────────────────┘

17 rows in set. Elapsed: 0.694 sec. Processed 1.33 million rows, 54.62 MB (1.92 million rows/s., 78.74 MB/s.)
Peak memory usage: 32.31 KiB.
```

Этот запрос далее ляжет в основу нескольких датасетов, которые мы будем визуализировать в *Superset*.

## Визуализация в *Superset*

### Датасеты

Здесь сразу хочу отметить момент, который оказался для меня неожиданным. Оказывается, в *Superset* нет простой возможности визуализировать на графике результат произвольного запроса. То есть, если у меня, допустим, уже есть запрос с группировкой и агрегациями, как в примере [выше](#clickhouse-menu-averaged-historical-prices-of-dishes), то я не могу его напрямую подключить и визуализировать в *Superset*. Потому что при создании графика (*chart*) *Superset* предполагает, что датасет &mdash; это таблица с исходными неагрегированными данными, и конструирует свой собственный запрос с группировками и агрегациями поверх него. И там даже нельзя создать метрику без операции агрегации (AVG, MIN, SUM и т.п.).

![Superset metrics aggregations](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/superset-metrics-aggregate.png)

Таким образом, если наш запрос уже сам по себе выполняет все необходимые группировки и агрегации, то, чтобы просто визуализировать его результат на графике, придётся использовать неочевидные методы: применять к существующей колонке &laquo;нейтральные&raquo; функции агрегации (напр. MAX) и т.д.

> Подробнее эта тема обсуждается, например в *issue* [#5570](https://github.com/apache/superset/issues/5570#issuecomment-410773587) в репозитории [*apache/superset*](https://github.com/apache/superset) на *GitHub*.

В итоге я попробовал создать 3 варианта датасетов в *Superset*:

1. Физическая таблица **menu_item_denorm**.
1. Виртуальный датасет, который по смыслу соответствует простому *View* в БД: запрос с дополнительными вычисляемыми колонками, но без агрегаций.

   ```sql
   SELECT
       menu_date,
       round(toUInt32OrZero(extract(menu_date, '^\\d{4}')), -1) AS decade,
       price,
       menu_currency,
       dish_name,
       menu_event,
       menu_venue
   FROM menu_item_denorm
   ```

   > Вычисляемые колонки [можно добавлять](https://superset.apache.org/docs/using-superset/creating-your-first-dashboard/#superset-semantic-layer) и к &laquo;физической&raquo; таблице.

1. Виртуальный датасет, соответствующий SQL запросу из примера [выше](#clickhouse-menu-averaged-historical-prices-of-dishes), который включает уже готовые фильтры, группировки и агрегации.

   ```sql
   SELECT
       round(toUInt32OrZero(extract(menu_date, '^\\d{4}')), -1) AS d,
       count() AS cnt,
       avg(price) AS price
   FROM menu_item_denorm
   WHERE (menu_currency = 'Dollars') AND (d > 0) AND (d < 2022)
   GROUP BY d
   ORDER BY d ASC;
   ```

Экран со списком датасетов в *Superset* выглядит так:

![Superset datasets](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/superset-datasets.png)

### Графики

Продемонстрируем работу с 3-мя датасетами, описанными [выше](#датасеты), на примерах использования их для визуализации данных.

#### *Averaged historical prices of dishes*

*Mixed chart*, на котором мы демонстрируем среднюю цену блюда в долларах за десятилетие, а также общее количество блюд (похоже, что Публичная библиотека Нью-Йорка с середины XX века сокращает деятельность по сбору этих данных).

![Averaged historical prices of dishes](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/averaged-historical-prices-of-dishes-chart.jpg)

Это как раз визуализация, построенная на готовом запросе с агрегациями. Если посмотреть на сгенерированный *Superset*-ом SQL, то видно, что он строится поверх исходного (внутреннего) запроса:

```sql
SELECT `d` AS `d_8277e0`, max(`price`) AS `Average Price_68aa98`
FROM (SELECT
    round(toUInt32OrZero(extract(menu_date, '^\\d{4}')), -1) AS d,
    count() AS cnt,
    avg(price) AS price
FROM menu_item_denorm
WHERE (menu_currency = 'Dollars') AND (d > 0) AND (d < 2022)
GROUP BY d
ORDER BY d ASC
) AS `virtual_table`
WHERE `d` > 0 AND `d` < 2022 GROUP BY `d` ORDER BY `Average Price_68aa98` ASC
 LIMIT 10000;
```

Поскольку в результате выполнения запроса значения поля `d` (десятилетие) уникальны, то функция `max(price)` нейтральна и просто возвращает нам значение средней цены из внутреннего запроса, что нам в этом случае и нужно. Но необходимо признать, что такой способ создания запроса для визуализации не является очевидным и вряд ли может быть рекомендуемым.

#### *Historical Prices Box Plot*

*Box Plot*, на котором можно представить сразу несколько статистик метрики (минимум, максимум, среднее, медиана, квартили и отклонения) по нескольким измерениям (группам агрегации). В данном случае для каждого десятилетия мы смотрим распределение *средней* цены по *Venue* и *Event*.

![Historical Prices Box Plot](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/historical-prices-box-plot-chart.jpg)

Запрос для графика построен на виртуальном датасете с вычисляемыми колонками без группировки и агрегаций. Сгенерированный *Superset*-ом SQL запрос:

```sql
SELECT `menu_venue` AS `menu_venue_6cc27d`, `menu_event` AS `menu_event_5b314e`, `decade` AS `decade_278791`, AVG(`price`) AS `AVG(price)_9e2c58`
FROM (SELECT
    menu_date,
    round(toUInt32OrZero(extract(menu_date, '^\\d{4}')), -1) AS decade,
    price,
    menu_currency,
    dish_name,
    menu_event,
    menu_venue
FROM menu_item_denorm
) AS `virtual_table`
WHERE `decade` >= 1900 AND `decade` < 2022 AND `menu_currency` IN ('Dollars') GROUP BY `menu_venue`, `menu_event`, `decade`
 LIMIT 50000;
```

С точки зрения подхода *Superset* этот вариант выглядит более естественным. Здесь только остаётся надеяться, что оптимизатор *ClickHouse* сможет переместить фильтры из внешнего запроса к внутреннему и *ClickHouse* не будет поднимать лишние данные с диска.

#### *Distribution by Venue and Event*

*Treemap*, на котором можно увидеть распределение количества записей по *Venue* (COMMERCIAL, RESTAURANT, ...) и *Event* (DINNER, LUNCH, ...).

![Distribution by Venue and Event](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/distribution-by-venue-and-event-chart.jpg)

Этот запрос построен напрямую на данных из таблицы **menu_item_denorm**. Сгенерированный *Superset*-ом SQL запрос:

```sql
SELECT `menu_venue` AS `menu_venue_6cc27d`, `menu_event` AS `menu_event_5b314e`, COUNT(*) AS `count_e2942a`
FROM `default`.`menu_item_denorm`
WHERE `menu_venue` IS NOT NULL AND (`menu_venue` NOT IN ('')) AND `menu_event` IS NOT NULL AND (`menu_event` NOT IN ('')) GROUP BY `menu_venue`, `menu_event`
HAVING ((COUNT(*) > 2500))
 LIMIT 10000;
```

Для более наглядной и красивой визуализации к исходным данным применены различные фильтры. Группировка соответствует полям из списка DIMENSIONS для данного типа визуализации.

### Итоговый *Dashboard*

Помимо описанных выше трёх графиков я ещё добавил два :

* *Burger Historical Price* (Area Chart),

  <details>

  <summary>SQL</summary>

    ```sql
    SELECT `decade` AS `decade_278791`, `menu_currency` AS `menu_currency_45c207`, AVG(`price`) AS `Average Price_68aa98`
    FROM (SELECT
        menu_date,
        round(toUInt32OrZero(extract(menu_date, '^\\d{4}')), -1) AS decade,
        price,
        menu_currency,
        dish_name,
        menu_event,
        menu_venue
    FROM menu_item_denorm
    ) AS `virtual_table`
    WHERE `menu_currency` IN ('Dollars') AND `decade` > 0 AND `decade` < 2022 AND ((dish_name ILIKE '%burger%')) GROUP BY `decade`, `menu_currency` ORDER BY max(`decade`) ASC
    LIMIT 10000;
    ```

  </details>
  <details>

  <summary>chart</summary>

  ![Burger Historical Price](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/burger-historical-price-chart.jpg)

  </details>

* *Distribution by Event* (Pie Chart).
  <details>

  <summary>SQL</summary>

  ```sql
  SELECT upper(menu_event) AS `menu_event_5b314e`, COUNT(*) AS `count_e2942a`
  FROM (SELECT
      menu_date,
      round(toUInt32OrZero(extract(menu_date, '^\\d{4}')), -1) AS decade,
      price,
      menu_currency,
      dish_name,
      menu_event,
      menu_venue
  FROM menu_item_denorm
  ) AS `virtual_table`
  WHERE `menu_venue` IS NOT NULL AND (`menu_venue` NOT IN ('')) AND `menu_event` IS NOT NULL AND (`menu_event` NOT IN ('')) GROUP BY upper(menu_event)
  HAVING ((COUNT(*) > 6000)) ORDER BY `count_e2942a` DESC
  LIMIT 100;
  ```

  </details>
  <details>

  <summary>chart</summary>

  ![Distribution by Event](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/distribution-by-event-chart.jpg)

  </details>

Итоговый дашборд на изображении ниже.

![What's on the Menu? Dashboard](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-02_BI/hw18/img/whats-on-the-menu-dashboard.jpg)

## Библиография

**\[1]** [*Visualizing Data with ClickHouse - Part 2 - Superset*](https://clickhouse.com/blog/visualizing-data-with-superset)
