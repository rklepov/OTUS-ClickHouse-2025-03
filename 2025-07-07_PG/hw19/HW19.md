# [19] Интеграция ClickHouse с PostgreSQL

![Querying Postgres from ClickHouse](https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-07-07_PG/hw19/clickhouse_postgres_options.png)

## Архитектура решения

Здесь я собираюсь в целом повторить структуру решения из задания [*[16] Загрузка данных в ClickHouse*](https://github.com/rklepov/OTUS-ClickHouse-2025-03/wiki/%5B16%5D-%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D0%B2-ClickHouse), где мы тоже переносили данные между БД *PostgreSQL* и *ClickHouse*, но только теперь без *Airbyte*.

Процессы *PostgreSQL* и *ClickHouse* работают в *Docker* контейнерах на виртуальной машине *Linux* (я работаю в Linux [CentOS 9](https://www.centos.org/stream9/) локально через [VirtualBox](https://www.virtualbox.org/)).

<details>

<summary>docker-compose.yaml</summary>

```yaml
version: "3.8"

services:
  postgres:
    image: postgres:latest
    command: -c config_file=/etc/postgresql/postgresql.conf
    restart: always
    hostname: postgres-host
    networks:
      - net
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    ports:
      - "0.0.0.0:15432:5432"
    volumes:
      - postgres_vol:/var/lib/postgresql/data
      - ${PWD}/fs/volumes/postgres/import:/import:Z
      - ${PWD}/fs/volumes/postgres/etc/postgresql/postgresql.conf:/etc/postgresql/postgresql.conf:Z

  clickhouse:
    image: "clickhouse/clickhouse-server:latest"
    user: "0:0"
    hostname: clickhouse-host
    networks:
      - net
    volumes:
      - clickhouse_vol:/var/lib/clickhouse
      - ${PWD}/fs/volumes/clickhouse/etc/clickhouse-server/config.d/config.xml:/etc/clickhouse-server/config.d/config.xml:Z
      - ${PWD}/fs/volumes/clickhouse/etc/clickhouse-server/users.d/users.xml:/etc/clickhouse-server/users.d/users.xml:Z
    ports:
      - "0.0.0.0:18123:8123"
      - "0.0.0.0:19000:9000"

volumes:
  postgres_vol:
    driver: local
  clickhouse_vol:
    driver: local

networks:
  net:
    driver: bridge
```

</details>

Все файлы конфигурации можно найти в текущем [репозитории](https://github.com/rklepov/OTUS-ClickHouse-2025-03/tree/main/2025-07-07_PG/hw19).

Запустим контейнеры с серверами *PostgreSQL* и *ClickHouse* c помощью команды `docker compose up -d`.

```shell
$ docker ps

CONTAINER ID  IMAGE                                          COMMAND     CREATED         STATUS                 PORTS                                                       NAMES
2852b1448aac  docker.io/library/postgres:latest              postgres    12 seconds ago  Up Less than a second  0.0.0.0:15432->5432/tcp                                     hw19_postgres_1
d59e98ae42d1  docker.io/clickhouse/clickhouse-server:latest              8 seconds ago   Up 6 seconds           0.0.0.0:18123->8123/tcp, 0.0.0.0:19000->9000/tcp, 9009/tcp  hw19_clickhouse_1
```

## PostgreSQL

### Тестовый датасет

Здесь я опять буду использовать демонстрационную базу данных [&laquo;Авиаперевозки&raquo;](https://postgrespro.ru/education/demodb), предоставляемую компанией [PostgresPro](https://postgrespro.ru/).

Загрузим архив с данными по полётам за один месяц и распакуем его в директорию, доступную из контейнера *PostgreSQL*.

```shell
$ wget -q --no-check-certificate https://edu.postgrespro.ru/demo-small.zip

$ unzip demo-small.zip -d fs/volumes/postgres/import/
Archive:  demo-small.zip
  inflating: fs/volumes/postgres/import/demo-small-20170815.sql

$ ls -hAlF fs/volumes/postgres/import/
total 100M
-rw-rw-r--. 1 rklepov rklepov 100M Aug 22  2017 demo-small-20170815.sql
```

Зайдём в контейнер *PostgreSQL* и создадим БД с помощью **psql** в соответствии с [инструкцией](https://postgrespro.ru/docs/postgrespro/15/demodb-bookings-installation).

```shell
$ docker exec -it hw19_postgres_1 bash

root@postgres-host:/# psql -f import/demo-small-20170815.sql -U postgres

. . . . .

COPY 9
COPY 104
COPY 579686
COPY 262788
COPY 33121
 setval
--------
  33121
(1 row)

COPY 1339
COPY 1045726
COPY 366733

. . . . .
```

Проверим состояние созданной БД:

```text
root@postgres-host:/# psql demo -U postgres
psql (17.5 (Debian 17.5-1.pgdg120+1))
Type "help" for help.

demo=# \set PROMPT1 '%/=> '
demo=> \d
                   List of relations
  Schema  |         Name          |   Type   |  Owner
----------+-----------------------+----------+----------
 bookings | aircrafts             | view     | postgres
 bookings | aircrafts_data        | table    | postgres
 bookings | airports              | view     | postgres
 bookings | airports_data         | table    | postgres
 bookings | boarding_passes       | table    | postgres
 bookings | bookings              | table    | postgres
 bookings | flights               | table    | postgres
 bookings | flights_flight_id_seq | sequence | postgres
 bookings | flights_v             | view     | postgres
 bookings | routes                | view     | postgres
 bookings | seats                 | table    | postgres
 bookings | ticket_flights        | table    | postgres
 bookings | tickets               | table    | postgres
(13 rows)
```

<a name="postgresql-select-from-bookings-airports-view"></a>
Сделаем запрос на *view* **airports**:

```sql
demo=> select * from airports limit 10;

 airport_code |  airport_name   |           city           |               coordinates               |      timezone
--------------+-----------------+--------------------------+-----------------------------------------+--------------------
 YKS          | Якутск          | Якутск                   | (129.77099609375,62.093299865722656)    | Asia/Yakutsk
 MJZ          | Мирный          | Мирный                   | (114.03900146484375,62.534698486328125) | Asia/Yakutsk
 KHV          | Хабаровск-Новый | Хабаровск                | (135.18800354004,48.52799987793)        | Asia/Vladivostok
 PKC          | Елизово         | Петропавловск-Камчатский | (158.45399475097656,53.16790008544922)  | Asia/Kamchatka
 UUS          | Хомутово        | Южно-Сахалинск           | (142.71800231933594,46.88869857788086)  | Asia/Sakhalin
 VVO          | Владивосток     | Владивосток              | (132.1479949951172,43.39899826049805)   | Asia/Vladivostok
 LED          | Пулково         | Санкт-Петербург          | (30.262500762939453,59.80030059814453)  | Europe/Moscow
 KGD          | Храброво        | Калининград              | (20.592599868774414,54.88999938964844)  | Europe/Kaliningrad
 KEJ          | Кемерово        | Кемерово                 | (86.1072006225586,55.27009963989258)    | Asia/Novokuznetsk
 CEK          | Челябинск       | Челябинск                | (61.5033,55.305801)                     | Asia/Yekaterinburg
(10 rows)
```

## ClickHouse

```sql
SELECT version()
FORMAT Raw

25.6.4.12
```

### Табличная Функция [`postgresql`](https://clickhouse.com/docs/sql-reference/table-functions/postgresql)

Данные тестового датасета *PostgreSQL* хранятся в [схеме](https://www.postgresql.org/docs/current/ddl-schemas.html) **bookings** БД **demo**, поэтому надо не забыть передать имя схемы в опциональном параметре табличной функции `postgresql`. В параметре *"имя таблицы"*, очевидно, можно передавать имя любого объекта БД, который допустимо использовать в `SELECT` запросе. Сделаем запрос на *view* **airports**, аналогичный запросу в **psql** [выше](#postgresql-select-from-bookings-airports-view), но теперь через *ClickHouse*:

```sql
SELECT *
FROM postgresql('postgres-host:5432', 'demo', 'airports', 'postgres', 'postgres', 'bookings')
LIMIT 10

    ┌─airport_code─┬─airport_name────┬─city─────────────────────┬─coordinates─────────────────────────────┬─timezone───────────┐
 1. │ YKS          │ Якутск          │ Якутск                   │ (129.77099609375,62.093299865722656)    │ Asia/Yakutsk       │
 2. │ MJZ          │ Мирный          │ Мирный                   │ (114.03900146484375,62.534698486328125) │ Asia/Yakutsk       │
 3. │ KHV          │ Хабаровск-Новый │ Хабаровск                │ (135.18800354004,48.52799987793)        │ Asia/Vladivostok   │
 4. │ PKC          │ Елизово         │ Петропавловск-Камчатский │ (158.45399475097656,53.16790008544922)  │ Asia/Kamchatka     │
 5. │ UUS          │ Хомутово        │ Южно-Сахалинск           │ (142.71800231933594,46.88869857788086)  │ Asia/Sakhalin      │
 6. │ VVO          │ Владивосток     │ Владивосток              │ (132.1479949951172,43.39899826049805)   │ Asia/Vladivostok   │
 7. │ LED          │ Пулково         │ Санкт-Петербург          │ (30.262500762939453,59.80030059814453)  │ Europe/Moscow      │
 8. │ KGD          │ Храброво        │ Калининград              │ (20.592599868774414,54.88999938964844)  │ Europe/Kaliningrad │
 9. │ KEJ          │ Кемерово        │ Кемерово                 │ (86.1072006225586,55.27009963989258)    │ Asia/Novokuznetsk  │
1.  │ CEK          │ Челябинск       │ Челябинск                │ (61.5033,55.305801)                     │ Asia/Yekaterinburg │
    └──────────────┴─────────────────┴──────────────────────────┴─────────────────────────────────────────┴────────────────────┘

10 rows in set. Elapsed: 0.048 sec.
```

Как можно видеть, результирующие наборы данных идентичны.

### Табличный движок [`PostgreSQL`](https://clickhouse.com/docs/integrations/postgresql#using-the-postgresql-table-engine)

Создадим новую стандартную ([`ENGINE = Atomic`](https://clickhouse.com/docs/engines/database-engines/atomic)) БД в *ClickHouse*.

```sql
CREATE DATABASE IF NOT EXISTS hw19
ENGINE = Atomic

Ok.

0 rows in set. Elapsed: 0.042 sec.
```

Попробуем подключить таблицу **bookings.flights** через табличный интеграционный движок [*PostgreSQL*](https://clickhouse.com/docs/engines/table-engines/integrations/postgresql).

Для создания таблицы на стороне *ClickHouse* необходимо знать её структуру (названия и типы полей). В данном случае эту информацию можно получить, применив [`DESCRIBE`](https://clickhouse.com/docs/sql-reference/statements/describe-table) к результату запроса через `postgresql`, аналогичному тому, что был сделан [выше](#табличная-функция-postgresql).

```sql
DESCRIBE TABLE
(
    SELECT *
    FROM postgresql('postgres-host:5432', 'demo', 'flights', 'postgres', 'postgres', 'bookings')
    LIMIT 1
)
FORMAT Raw

flight_id       Int32
flight_no       String
scheduled_departure     DateTime64(6)
scheduled_arrival       DateTime64(6)
departure_airport       String
arrival_airport String
status  String
aircraft_code   String
actual_departure        Nullable(DateTime64(6))
actual_arrival  Nullable(DateTime64(6))

10 rows in set. Elapsed: 0.052 sec.
```

Теперь по полученной информации довольно легко сформировать DDL запрос [`CREATE TABLE`](https://clickhouse.com/docs/sql-reference/statements/create/table).

```sql
CREATE OR REPLACE TABLE hw19.flights
(
    `flight_id` Int32,
    `flight_no` String,
    `scheduled_departure` DateTime64(6),
    `scheduled_arrival` DateTime64(6),
    `departure_airport` String,
    `arrival_airport` String,
    `status` String,
    `aircraft_code` String,
    `actual_departure` Nullable(DateTime64(6)),
    `actual_arrival` Nullable(DateTime64(6))
)
ENGINE = PostgreSQL('postgres-host:5432', 'demo', 'flights', 'postgres', 'postgres', 'bookings')

Ok.

0 rows in set. Elapsed: 0.044 sec.
```

Сделаем запрос к таблице **hw19.flights**.

```sql
SELECT
    flight_id,
    flight_no,
    toDateTime(scheduled_departure) AS scheduled_departure,
    toDateTime(scheduled_arrival) AS scheduled_arrival,
    departure_airport,
    arrival_airport,
    status,
    aircraft_code
FROM hw19.flights
LIMIT 10

    ┌─flight_id─┬─flight_no─┬─scheduled_departure─┬───scheduled_arrival─┬─departure_airport─┬─arrival_airport─┬─status────┬─aircraft_code─┐
 1. │      1185 │ PG0134    │ 2017-09-10 06:50:00 │ 2017-09-10 11:55:00 │ DME               │ BTK             │ Scheduled │ 319           │
 2. │      3979 │ PG0052    │ 2017-08-25 11:50:00 │ 2017-08-25 14:35:00 │ VKO               │ HMA             │ Scheduled │ CR2           │
 3. │      4739 │ PG0561    │ 2017-09-05 09:30:00 │ 2017-09-05 11:15:00 │ VKO               │ AER             │ Scheduled │ 763           │
 4. │      5502 │ PG0529    │ 2017-09-12 06:50:00 │ 2017-09-12 08:20:00 │ SVO               │ UFA             │ Scheduled │ 763           │
 5. │      6938 │ PG0461    │ 2017-09-04 09:25:00 │ 2017-09-04 10:20:00 │ SVO               │ ULV             │ Scheduled │ SU9           │
 6. │      7784 │ PG0667    │ 2017-09-10 12:00:00 │ 2017-09-10 14:30:00 │ SVO               │ KRO             │ Scheduled │ CR2           │
 7. │      9478 │ PG0360    │ 2017-08-28 06:00:00 │ 2017-08-28 08:35:00 │ LED               │ REN             │ Scheduled │ CR2           │
 8. │     11085 │ PG0569    │ 2017-08-24 12:05:00 │ 2017-08-24 13:10:00 │ SVX               │ SCW             │ Scheduled │ 733           │
 9. │     11847 │ PG0498    │ 2017-09-12 07:15:00 │ 2017-09-12 11:55:00 │ KZN               │ IKT             │ Scheduled │ 319           │
10. │     12012 │ PG0621    │ 2017-08-26 13:05:00 │ 2017-08-26 14:00:00 │ KZN               │ MQF             │ Scheduled │ CR2           │
    └───────────┴───────────┴─────────────────────┴─────────────────────┴───────────────────┴─────────────────┴───────────┴───────────────┘

10 rows in set. Elapsed: 0.200 sec.
```

### Движок БД [`PostgreSQL`](https://clickhouse.com/docs/engines/database-engines/postgresql)

Наконец, попробуем подключить БД **demo.bookings** из *PostgreSQL* целиком, используя соответствующий интеграционный движок БД в *ClickHouse*.

```sql
CREATE DATABASE IF NOT EXISTS hw19_pg
ENGINE = PostgreSQL('postgres-host:5432', 'demo', 'postgres', 'postgres', 'bookings')

0 rows in set. Elapsed: 0.042 sec.
```

Посмотрим, какие таблицы в БД **hw19_pg** нам доступны:

```sql
SHOW TABLES FROM hw19_pg

   ┌─name────────────┐
1. │ aircrafts_data  │
2. │ airports_data   │
3. │ boarding_passes │
4. │ bookings        │
5. │ flights         │
6. │ seats           │
7. │ table1          │
8. │ ticket_flights  │
9. │ tickets         │
   └─────────────────┘

9 rows in set. Elapsed: 0.096 sec.
```

Интересно, что, хотя никаких *view* из БД **demo.bookings** *PostgreSQL* нет в списке, тем не менее мы успешно можем делать запросы на них:

```sql
SELECT
    flight_no,
    departure_airport,
    departure_city,
    arrival_airport,
    arrival_city,
    aircraft_code,
    duration,
    days_of_week
FROM hw19_pg.routes
LIMIT 10

    ┌─flight_no─┬─departure_airport─┬─departure_city─┬─arrival_airport─┬─arrival_city─┬─aircraft_code─┬─duration─┬─days_of_week────┐
 1. │ PG0001    │ UIK               │ Усть-Илимск    │ SGC             │ Сургут       │ CR2           │ 02:20:00 │ [6]             │
 2. │ PG0002    │ SGC               │ Сургут         │ UIK             │ Усть-Илимск  │ CR2           │ 02:20:00 │ [7]             │
 3. │ PG0003    │ IWA               │ Иваново        │ AER             │ Сочи         │ CR2           │ 02:10:00 │ [2,6]           │
 4. │ PG0004    │ AER               │ Сочи           │ IWA             │ Иваново      │ CR2           │ 02:10:00 │ [3,7]           │
 5. │ PG0005    │ DME               │ Москва         │ PKV             │ Псков        │ CN1           │ 02:05:00 │ [2,5,7]         │
 6. │ PG0006    │ PKV               │ Псков          │ DME             │ Москва       │ CN1           │ 02:05:00 │ [1,4,6]         │
 7. │ PG0007    │ VKO               │ Москва         │ JOK             │ Йошкар-Ола   │ CN1           │ 02:10:00 │ [1,2,3,4,5,6,7] │
 8. │ PG0008    │ VKO               │ Москва         │ JOK             │ Йошкар-Ола   │ CN1           │ 02:10:00 │ [1,2,3,4,5,6,7] │
 9. │ PG0009    │ JOK               │ Йошкар-Ола     │ VKO             │ Москва       │ CN1           │ 02:10:00 │ [1,2,3,4,5,6,7] │
10. │ PG0010    │ JOK               │ Йошкар-Ола     │ VKO             │ Москва       │ CN1           │ 02:10:00 │ [1,2,3,4,5,6,7] │
    └───────────┴───────────────────┴────────────────┴─────────────────┴──────────────┴───────────────┴──────────┴─────────────────┘

10 rows in set. Elapsed: 0.385 sec.
```

Судя по всему, внутри используется та же функция [`postgresql`](https://clickhouse.com/docs/sql-reference/table-functions/postgresql) (либо скорее существует общая реализация для движка и функции), которая просто транслирует запрос на сервер *PostgreSQL* и, если запрос был успешным, то необходимым образом трансформирует полученный результат.

Важным фактом также является поддержка в том числе сложных типов данных, в частности агрегатов (в данном случае [*Array*](https://clickhouse.com/docs/sql-reference/data-types/array) в поле *days_of_week*):

```sql
SHOW CREATE TABLE hw19_pg.routes
FORMAT Raw

CREATE TABLE hw19_pg.routes
(
    `flight_no` Nullable(String),
    `departure_airport` Nullable(String),
    `departure_airport_name` Nullable(String),
    `departure_city` Nullable(String),
    `arrival_airport` Nullable(String),
    `arrival_airport_name` Nullable(String),
    `arrival_city` Nullable(String),
    `aircraft_code` Nullable(String),
    `duration` Nullable(String),
    `days_of_week` Array(Nullable(Int32))
)
ENGINE = PostgreSQL('postgres-host:5432', 'demo', 'routes', 'postgres', '[HIDDEN]')
```

## Библиография

**\[1]** [*ClickHouse and PostgreSQL - a Match Made in Data Heaven - part 1*](https://clickhouse.com/blog/migrating-data-between-clickhouse-postgres)

**\[2]** [*ClickHouse and PostgreSQL - a Match Made in Data Heaven - part 2*](https://clickhouse.com/blog/migrating-data-between-clickhouse-postgres-part-2)
