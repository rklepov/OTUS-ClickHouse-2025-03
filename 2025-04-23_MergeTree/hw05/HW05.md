# [05] Движки MergeTree

```sql
SELECT version()
   ┌─version()─┐
1. │ 25.4.2.31 │
   └───────────┘
```

> Ниже вывод `clickhouse-client` был модифицирован для краткости и удобства чтения (удалена лишняя в данном контексте информация вроде *Query id* и т.п.)

## 1. [VersionedCollapsingMergeTree](https://clickhouse.com/docs/engines/table-engines/mergetree-family/versionedcollapsingmergetree)

```sql
CREATE TABLE tbl1
(
    `UserID` UInt64,
    `PageViews` UInt8,
    `Duration` UInt8,
    `Sign` Int8,
    `Version` UInt8
)
ENGINE = VersionedCollapsingMergeTree(Sign, Version)
ORDER BY UserID;
0 rows in set. Elapsed: 0.020 sec.


INSERT INTO tbl1 VALUES (4324182021466249494, 5, 146, -1, 1);
1 row in set. Elapsed: 0.009 sec.


SELECT * FROM tbl1
   ┌──────────────UserID─┬─PageViews─┬─Duration─┬─Sign─┬─Version─┐
1. │ 4324182021466249494 │         5 │      146 │   -1 │       1 │
   └─────────────────────┴───────────┴──────────┴──────┴─────────┘
1 row in set. Elapsed: 0.003 sec.


INSERT INTO tbl1 VALUES (4324182021466249494, 5, 146, 1, 1),(4324182021466249494, 6, 185, 1, 2);
2 rows in set. Elapsed: 0.011 sec.


SELECT * FROM tbl1
   ┌──────────────UserID─┬─PageViews─┬─Duration─┬─Sign─┬─Version─┐
1. │ 4324182021466249494 │         5 │      146 │    1 │       1 │
2. │ 4324182021466249494 │         6 │      185 │    1 │       2 │
3. │ 4324182021466249494 │         5 │      146 │   -1 │       1 │
   └─────────────────────┴───────────┴──────────┴──────┴─────────┘
3 rows in set. Elapsed: 0.006 sec.


SELECT * FROM tbl1 FINAL
   ┌──────────────UserID─┬─PageViews─┬─Duration─┬─Sign─┬─Version─┐
1. │ 4324182021466249494 │         6 │      185 │    1 │       2 │
   └─────────────────────┴───────────┴──────────┴──────┴─────────┘
1 row in set. Elapsed: 0.009 sec.

```

Здесь уже само наличие полей `Sign` и  `Version` намекает нам на тип требуемого движка: *VersionedCollapsingMergeTree*. Данные были вставлены в неправильном порядке (сначала удаление, *-1*), потом вставка. Но наличие версии и использование соответствующего движка позволяет &laquo;схлопнуть&raquo; обновления по *UserID* как мы и ожидаем.

## 2. [ReplacingMergeTree](https://clickhouse.com/docs/engines/table-engines/mergetree-family/replacingmergetree)

```sql
CREATE TABLE tbl2
(
    `key` UInt32,
    `value` UInt32
)
ENGINE = ReplacingMergeTree()
ORDER BY key;
0 rows in set. Elapsed: 0.021 sec.


INSERT INTO tbl2 Values(1,1),(1,2),(2,1);
3 rows in set. Elapsed: 0.012 sec.


SELECT * FROM tbl2
   ┌─key─┬─value─┐
1. │   1 │     2 │
2. │   2 │     1 │
   └─────┴───────┘
2 rows in set. Elapsed: 0.004 sec.
```

Здесь достаточно очевидный случай: удаление дубликатов по ключу. Используем движок *ReplacingMergeTree*.

## 3. [ReplacingMergeTree](https://clickhouse.com/docs/engines/table-engines/mergetree-family/replacingmergetree) (again)

```sql
CREATE TABLE tbl3
(
    `id` Int32,
    `status` String,
    `price` String,
    `comment` String
)
ENGINE = ReplacingMergeTree()
PRIMARY KEY id
ORDER BY (id, status);
0 rows in set. Elapsed: 0.022 sec.


INSERT INTO tbl3 VALUES (23, 'success', '1000', 'Confirmed');
1 row in set. Elapsed: 0.010 sec.


SELECT * FROM tbl3 WHERE id = 23
   ┌─id─┬─status──┬─price─┬─comment───┐
1. │ 23 │ success │ 1000  │ Confirmed │
   └────┴─────────┴───────┴───────────┘
1 row in set. Elapsed: 0.006 sec.


INSERT INTO tbl3 VALUES (23, 'success', '2000', 'Cancelled');
1 row in set. Elapsed: 0.007 sec.


SELECT * FROM tbl3 WHERE id = 23
   ┌─id─┬─status──┬─price─┬─comment───┐
1. │ 23 │ success │ 2000  │ Cancelled │
2. │ 23 │ success │ 1000  │ Confirmed │
   └────┴─────────┴───────┴───────────┘
2 rows in set. Elapsed: 0.012 sec.


SELECT * FROM tbl3 FINAL WHERE id = 23
   ┌─id─┬─status──┬─price─┬─comment───┐
1. │ 23 │ success │ 2000  │ Cancelled │
   └────┴─────────┴───────┴───────────┘
1 row in set. Elapsed: 0.005 sec.

```

Здесь тоже используем движок *ReplacingMergeTree*, но в данном случае особенность в том, что данные вставляются двумя отдельными операциями, поэтому попадают в разные [*parts*](https://clickhouse.com/docs/parts). Поскольку *ClickHouse* производит слияния асинхронно в фоновом режиме, то прямой запрос данных сразу после вставки вернёт нам обе записи. Однако, если использовать модификатор [`FINAL`](https://clickhouse.com/docs/sql-reference/statements/select/from#final-modifier), то нам вернётся результат, в том виде, каким он будет после слияния: данные были дедуплицированы по ключу.

## 4. [AggregatingMergeTree](https://clickhouse.com/docs/engines/table-engines/mergetree-family/aggregatingmergetree)

```sql
CREATE TABLE tbl4
(
    `CounterID` UInt8,
    `StartDate` Date,
    `UserID` UInt64
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(StartDate)
ORDER BY (CounterID, StartDate);
0 rows in set. Elapsed: 0.019 sec.


INSERT INTO tbl4 VALUES(0, '2019-11-11', 1);
1 row in set. Elapsed: 0.011 sec.

INSERT INTO tbl4 VALUES(1, '2019-11-12', 1);
1 row in set. Elapsed: 0.011 sec.


CREATE TABLE tbl5
(
    `CounterID` UInt8,
    `StartDate` Date,
    `UserID` AggregateFunction(uniq, UInt64)
)
ENGINE = AggregatingMergeTree()
PARTITION BY toYYYYMM(StartDate)
ORDER BY (CounterID, StartDate);
0 rows in set. Elapsed: 0.025 sec.


INSERT INTO tbl5 SELECT
    CounterID,
    StartDate,
    uniqState(UserID)
FROM tbl4
GROUP BY
    CounterID,
    StartDate
0 rows in set. Elapsed: 0.016 sec.


INSERT INTO tbl5 VALUES (1,'2019-11-12',1);
Error on processing query: Code: 53. DB::Exception: Cannot convert UInt64 to AggregateFunction(uniq, UInt64):
While executing ValuesBlockInputFormat: data for INSERT was parsed from query. (TYPE_MISMATCH)
(version 25.4.2.31 (official build))


SELECT uniqMerge(UserID) AS state
FROM tbl5
GROUP BY
    CounterID,
    StartDate

   ┌─state─┐
1. │     1 │
2. │     1 │
   └───────┘
2 rows in set. Elapsed: 0.007 sec.
```

C **tbl4** в данном случае всё просто: она используется только как источник данных без каких-либо особенностей, поэтому для неё используем классический [*MergeTree*](https://clickhouse.com/docs/engines/table-engines/mergetree-family/mergetree).

**tbl5** &mdash; это уже пример использования движка *AggregatingMergeTree*. Во-первых, об этом нам подсказывает поле с типом [*AggregateFunction*](https://clickhouse.com/docs/sql-reference/data-types/aggregatefunction). А, во-вторых, ошибка при попытке прямой вставки значения в соответствующее поле (без использования агрегатной функции с комбинатором [`-State`](https://clickhouse.com/docs/sql-reference/aggregate-functions/combinators#-state)).

## 5. [CollapsingMergeTree](https://clickhouse.com/docs/engines/table-engines/mergetree-family/collapsingmergetree)

```sql
CREATE TABLE tbl6
(
    `id` Int32,
    `status` String,
    `price` String,
    `comment` String,
    `sign` Int8
)
ENGINE = CollapsingMergeTree(sign)
PRIMARY KEY id
ORDER BY (id, status);
0 rows in set. Elapsed: 0.019 sec.


INSERT INTO tbl6 VALUES (23, 'success', '1000', 'Confirmed', 1);
1 row in set. Elapsed: 0.014 sec.


INSERT INTO tbl6 VALUES (23, 'success', '1000', 'Confirmed', -1), (23, 'success', '2000', 'Cancelled', 1);
2 rows in set. Elapsed: 0.010 sec.


SELECT * FROM tbl6
   ┌─id─┬─status──┬─price─┬─comment───┬─sign─┐
1. │ 23 │ success │ 1000  │ Confirmed │   -1 │
2. │ 23 │ success │ 2000  │ Cancelled │    1 │
3. │ 23 │ success │ 1000  │ Confirmed │    1 │
   └────┴─────────┴───────┴───────────┴──────┘
3 rows in set. Elapsed: 0.009 sec.


SELECT * FROM tbl6 FINAL
   ┌─id─┬─status──┬─price─┬─comment───┬─sign─┐
1. │ 23 │ success │ 2000  │ Cancelled │    1 │
   └────┴─────────┴───────┴───────────┴──────┘
1 row in set. Elapsed: 0.004 sec.
```

Здесь опять же наличие поля `sign` подсказывает нам используемый движок: *CollapsingMergeTree*. В отличие от [п.1](#1-versionedcollapsingmergetree), здесь удаление происходит в правильном порядке относительно вставки, поэтому &laquo;коллаписрование&raquo; записей по ключу происходит ожидаемым образом.
