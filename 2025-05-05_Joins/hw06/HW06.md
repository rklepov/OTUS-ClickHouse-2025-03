# [06] Джоины и агрегации

> Команды создания таблиц и загрузки данных опущены, потому что они просто были скопированы из задания.
> Используемый датасет и задачи аналогичны тем, которые рассматривались в статье [Join Types supported in ClickHouse](https://clickhouse.com/blog/clickhouse-fully-supports-joins-part1).

## Найти жанры для каждого фильма

Используем обычный [`INNER JOIN`](https://clickhouse.com/blog/clickhouse-fully-supports-joins-part1#inner-join) по **movie_id**. Поскольку у каждого фильма может быть более одного жанра, то записи из таблицы *movies* могут повторяться несколько раз, для каждой записи из *genres* с соответствующим **id**. При этом фильмы, для которых не определено ни одного жанра, не попадут в результирующую выборку.

```sql
SELECT
    name,
    year,
    rank,
    genre
FROM imdb.movies AS m
INNER JOIN imdb.genres AS g ON m.id = g.movie_id
ORDER BY
    year DESC,
    name ASC,
    genre ASC
LIMIT 10

    ┌─name───────────────────────────────────┬─year─┬─rank─┬─genre─────┐
 1. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Action    │
 2. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Adventure │
 3. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Family    │
 4. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Fantasy   │
 5. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Thriller  │
 6. │ DragonBall Z                           │ 2007 │    0 │ Action    │
 7. │ DragonBall Z                           │ 2007 │    0 │ Adventure │
 8. │ DragonBall Z                           │ 2007 │    0 │ Comedy    │
 9. │ DragonBall Z                           │ 2007 │    0 │ Fantasy   │
10. │ DragonBall Z                           │ 2007 │    0 │ Sci-Fi    │
    └────────────────────────────────────────┴──────┴──────┴───────────┘

10 rows in set. Elapsed: 0.126 sec. Processed 783.39 thousand rows, 23.06 MB (6.21 million rows/s., 182.71 MB/s.)
Peak memory usage: 74.02 MiB.
```

Конечно, было бы удобнее, если бы запись по фильму была в единственном экземпляре, а жанры перечислялись бы списком. Это можно сделать, например, с помощью внешнего запроса с группировкой:

```sql
SELECT
    first_value(name) AS name,
    first_value(year) AS year,
    first_value(rank) AS rank,
    groupArray(genre) AS genres
FROM
(
    SELECT
        id,
        name,
        year,
        rank,
        genre
    FROM imdb.movies AS m
    INNER JOIN imdb.genres AS g ON m.id = g.movie_id
)
GROUP BY id
ORDER BY
    year DESC,
    name ASC
LIMIT 10

    ┌─name──────────────────────────────────────┬─year─┬─rank─┬─genres───────────────────────────────────────────────┐
 1. │ Harry Potter and the Half-Blood Prince    │ 2008 │    0 │ ['Action','Adventure','Family','Fantasy','Thriller'] │
 2. │ DragonBall Z                              │ 2007 │    0 │ ['Action','Adventure','Comedy','Fantasy','Sci-Fi']   │
 3. │ Harry Potter and the Order of the Phoenix │ 2007 │    0 │ ['Adventure','Family','Fantasy']                     │
 4. │ Rapunzel Unbraided                        │ 2007 │    0 │ ['Animation','Family']                               │
 5. │ Spider-Man 3                              │ 2007 │    0 │ ['Action','Drama','Fantasy']                         │
 6. │ Tripoli                                   │ 2007 │    0 │ ['Adventure']                                        │
 7. │ Untitled Star Trek Prequel                │ 2007 │    0 │ ['Sci-Fi']                                           │
 8. │ War of the Red Cliff, The                 │ 2007 │    0 │ ['Action']                                           │
 9. │ 10th & Wolf                               │ 2006 │    0 │ ['Crime','Drama']                                    │
10. │ 2176                                      │ 2006 │    0 │ ['Action','Adventure','Fantasy','Musical','Sci-Fi']  │
    └───────────────────────────────────────────┴──────┴──────┴──────────────────────────────────────────────────────┘

10 rows in set. Elapsed: 0.392 sec. Processed 783.39 thousand rows, 23.06 MB (2.00 million rows/s., 58.80 MB/s.)
Peak memory usage: 119.12 MiB.
```

## Запросить все фильмы, у которых нет жанра

Простой способ решить эту задачу &mdash; [`LEFT OUTER JOIN`](https://clickhouse.com/blog/clickhouse-fully-supports-joins-part1#left--right--full-outer-join) с последующей фильтрацией записей, в которых правая сторона &laquo;пустая&raquo; (в данном случае **movie_id** заполнен значением по умолчанию, т.е. **0**).

```sql
SELECT
    name,
    year,
    rank
FROM imdb.movies AS m
LEFT JOIN imdb.genres AS g ON m.id = g.movie_id
WHERE g.movie_id = 0
ORDER BY
    year DESC,
    name ASC
LIMIT 10

    ┌─name──────────────────────────────────────┬─year─┬─rank─┐
 1. │ """Pacific War, The"""                    │ 2006 │    0 │
 2. │ """Turin 2006: XX Olympic Winter Games""" │ 2006 │    0 │
 3. │ Arthur, the Movie                         │ 2006 │    0 │
 4. │ Bridge to Terabithia                      │ 2006 │    0 │
 5. │ Mars in Aries                             │ 2006 │    0 │
 6. │ Master of Space and Time                  │ 2006 │    0 │
 7. │ Ninth Life of Louis Drax, The             │ 2006 │    0 │
 8. │ Paradox                                   │ 2006 │    0 │
 9. │ Ratatouille                               │ 2006 │    0 │
10. │ """American Dad"""                        │ 2005 │    0 │
    └───────────────────────────────────────────┴──────┴──────┘

10 rows in set. Elapsed: 0.306 sec. Processed 783.39 thousand rows, 16.97 MB (2.56 million rows/s., 55.42 MB/s.)
Peak memory usage: 75.75 MiB.
```

Есть более элегантный способ решить эту задачу, с помощью `ANTI JOIN`, он рассмотрен [ниже](#запросить-все-фильмы-у-которых-нет-жанра-через-anti-join).

## Объединить каждую строку из таблицы &laquo;Фильмы&raquo; с каждой строкой из таблицы &laquo;Жанры&raquo;

Предполагаю, что здесь имелся в виду [`CROSS JOIN`](https://clickhouse.com/blog/clickhouse-fully-supports-joins-part1#cross-join).

```sql
SELECT
    m.id,
    name,
    year,
    rank,
    g.movie_id,
    genre
FROM imdb.movies AS m
CROSS JOIN imdb.genres AS g
LIMIT 10

    ┌─────id─┬─name───────────────────┬─year─┬─rank─┬─movie_id─┬─genre───────┐
 1. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92868 │ Action      │
 2. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92868 │ Adventure   │
 3. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92868 │ Fantasy     │
 4. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92869 │ Action      │
 5. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92869 │ Fantasy     │
 6. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92870 │ Short       │
 7. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92871 │ Fantasy     │
 8. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92872 │ Documentary │
 9. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92873 │ Documentary │
10. │ 314780 │ Still Crazy Like a Fox │ 1987 │    0 │    92874 │ Documentary │
    └────────┴────────────────────────┴──────┴──────┴──────────┴─────────────┘

10 rows in set. Elapsed: 0.041 sec. Processed 591.73 thousand rows, 15.41 MB (14.44 million rows/s., 376.12 MB/s.)
Peak memory usage: 38.47 MiB.
```

## Найти жанры для каждого фильма, НЕ используя `INNER JOIN`

Видимо, здесь предлагается сделать [`CROSS JOIN`](https://clickhouse.com/blog/clickhouse-fully-supports-joins-part1#cross-join) с фильтром.

```sql
SELECT
    name,
    year,
    rank,
    genre
FROM imdb.movies AS m
CROSS JOIN imdb.genres AS g
WHERE m.id = g.movie_id
ORDER BY
    year DESC,
    name ASC,
    genre ASC
LIMIT 10

    ┌─name───────────────────────────────────┬─year─┬─rank─┬─genre─────┐
 1. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Action    │
 2. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Adventure │
 3. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Family    │
 4. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Fantasy   │
 5. │ Harry Potter and the Half-Blood Prince │ 2008 │    0 │ Thriller  │
 6. │ DragonBall Z                           │ 2007 │    0 │ Action    │
 7. │ DragonBall Z                           │ 2007 │    0 │ Adventure │
 8. │ DragonBall Z                           │ 2007 │    0 │ Comedy    │
 9. │ DragonBall Z                           │ 2007 │    0 │ Fantasy   │
10. │ DragonBall Z                           │ 2007 │    0 │ Sci-Fi    │
    └────────────────────────────────────────┴──────┴──────┴───────────┘

10 rows in set. Elapsed: 0.109 sec. Processed 783.39 thousand rows, 23.06 MB (7.17 million rows/s., 210.98 MB/s.)
Peak memory usage: 79.76 MiB.
```

Как можно убедиться, результат такой же как в [задании 1](#найти-жанры-для-каждого-фильма). Это неудивительно: в документации описана опция [`cross_to_inner_join_rewrite`](https://clickhouse.com/docs/operations/settings/formats#cross_to_inner_join_rewrite), которая по умолчанию включена и позволяет *ClickHouse* трансформировать `CROSS JOIN` с соответствующим фильтром в `INNER JOIN`.

## Найти всех актеров и актрис, снявшихся в фильме в N году

Похоже, поле **created_at** таблицы *roles* имеет другой смысл, а вовсе не год съёмки: в загруженных данных в этом поле таблицы указан одинаковый момент времени для всех записей (кажется, это просто момент создания датасета). Тем не менее, другого поля с временем у нас нет, поэтому условно будем фильтровать по нему (хотя это и лишено смысла).

А в целом идея состоит в использовании [`SEMI JOIN`](https://clickhouse.com/blog/clickhouse-fully-supports-joins-part1#left--right-semi-join): нам нужно только первое совпадение, а не декартово произведение.

```sql
SELECT
    first_name,
    last_name,
    role,
    toYear(created_at) AS year
FROM imdb.actors AS a
SEMI LEFT JOIN imdb.roles AS r ON a.id = r.actor_id
WHERE year = 2025
ORDER BY id ASC
LIMIT 10

    ┌─first_name─┬─last_name──────────────┬─role──────────────────────────┬─year─┐
 1. │ Michael    │ 'babeepower' Viera     │ Stevie                        │ 2025 │
 2. │ Eloy       │ 'Chincheta'            │ Gitano 1                      │ 2025 │
 3. │ Dieguito   │ 'El Cigala'            │ El Cigala                     │ 2025 │
 4. │ Antonio    │ 'El de Chipiona'       │ Himself                       │ 2025 │
 5. │ José       │ 'El Francés'           │ ""                            │ 2025 │
 6. │ Félix      │ 'El Gato'              │ ""                            │ 2025 │
 7. │ Marcial    │ 'El Jalisco'           │ ""                            │ 2025 │
 8. │ José       │ 'El Morito'            │ Amigo Cigala #2               │ 2025 │
 9. │ Francisco  │ 'El Niño de la Manola' │ Segundo Cuadro Flamenco 'Tang │ 2025 │
10. │ Víctor     │ 'El Payaso'            │ Chavo Banda Galerias          │ 2025 │
    └────────────┴────────────────────────┴───────────────────────────────┴──────┘

10 rows in set. Elapsed: 0.640 sec. Processed 4.25 million rows, 118.61 MB (6.64 million rows/s., 185.31 MB/s.)
Peak memory usage: 138.97 MiB.
```

## Запросить все фильмы, у которых нет жанра, через `ANTI JOIN`

Используем [LEFT ANTI JOIN](https://clickhouse.com/blog/clickhouse-fully-supports-joins-part1#left--right-anti-join).

```sql
SELECT
    name,
    year,
    rank
FROM imdb.movies AS m
ANTI LEFT JOIN imdb.genres AS g ON m.id = g.movie_id
ORDER BY
    year DESC,
    name ASC
LIMIT 10

    ┌─name──────────────────────────────────────┬─year─┬─rank─┐
 1. │ """Pacific War, The"""                    │ 2006 │    0 │
 2. │ """Turin 2006: XX Olympic Winter Games""" │ 2006 │    0 │
 3. │ Arthur, the Movie                         │ 2006 │    0 │
 4. │ Bridge to Terabithia                      │ 2006 │    0 │
 5. │ Mars in Aries                             │ 2006 │    0 │
 6. │ Master of Space and Time                  │ 2006 │    0 │
 7. │ Ninth Life of Louis Drax, The             │ 2006 │    0 │
 8. │ Paradox                                   │ 2006 │    0 │
 9. │ Ratatouille                               │ 2006 │    0 │
10. │ """American Dad"""                        │ 2005 │    0 │
    └───────────────────────────────────────────┴──────┴──────┘

10 rows in set. Elapsed: 0.052 sec. Processed 783.39 thousand rows, 16.97 MB (14.93 million rows/s., 323.44 MB/s.)
Peak memory usage: 31.11 MiB.
```

Как можно видеть, результат такой же, как в [задании 2](#запросить-все-фильмы-у-которых-нет-жанра).
