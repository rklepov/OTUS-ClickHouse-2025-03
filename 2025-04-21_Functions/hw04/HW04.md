# [04] Обработка данных

## **Вариант 1**

### Создание таблицы

```sql
CREATE OR REPLACE TABLE transactions
(
    `transaction_id` UInt32,
    `user_id` UInt32,
    `product_id` UInt32,
    `quantity` UInt8,
    `price` Float32,
    `transaction_date` Date
)
ENGINE = MergeTree
ORDER BY transaction_id

```

### Заполнение таблицы [рандомизированными](https://clickhouse.com/blog/generating-random-test-distribution-data-for-clickhouse) данными (100 000 записей)

```sql
INSERT INTO transactions SELECT
    number + 1,
    1 + floor(randUniform(0, 10000)),
    1 + floor(randUniform(0, 15000)),
    1 + floor(randExponential(1 / 10)),
    round(randNormal(1000, 333), 2),
    toDate(now() - toIntervalDay(randUniform(1, 366)))
FROM numbers(100000)

Ok.

0 rows in set. Elapsed: 0.044 sec. Processed 100.00 thousand rows, 800.00 KB (2.26 million rows/s., 18.05 MB/s.)
Peak memory usage: 4.22 MiB.

SELECT *
FROM transactions
LIMIT 10

    ┌─transaction_id─┬─user_id─┬─product_id─┬─quantity─┬───price─┬─transaction_date─┐
 1. │              1 │    9405 │       5091 │       10 │  375.41 │       2024-04-29 │
 2. │              2 │    5873 │       9683 │        4 │  1429.1 │       2025-01-28 │
 3. │              3 │    4808 │      14327 │        5 │ 1497.64 │       2025-03-20 │
 4. │              4 │    5254 │         98 │        5 │  869.29 │       2025-01-25 │
 5. │              5 │    1018 │       2210 │        3 │  422.55 │       2025-01-21 │
 6. │              6 │    4427 │        507 │       36 │   531.4 │       2024-12-28 │
 7. │              7 │    9379 │       1307 │       10 │ 1298.88 │       2025-04-05 │
 8. │              8 │    7933 │       3385 │        1 │ 1035.77 │       2025-04-10 │
 9. │              9 │    6045 │       9919 │        7 │  696.77 │       2024-12-24 │
10. │             10 │    1793 │       7593 │       23 │  560.96 │       2025-01-05 │
    └────────────────┴─────────┴────────────┴──────────┴─────────┴──────────────────┘

```

### Агрегатные функции

```sql
SELECT
    round(sum(quantity * price), 2) AS totalVolume,
    round(avg(quantity * price), 2) AS avgVolume,
    sum(quantity) AS totalAmount,
    count(DISTINCT user_id) AS cntDistinctUsers
FROM transactions

   ┌───totalVolume─┬─avgVolume─┬─totalAmount─┬─cntDistinctUsers─┐
1. │ 1044002909.21 │  10440.03 │     1048691 │             9999 │
   └───────────────┴───────────┴─────────────┴──────────────────┘
```

### Функции для работы с типами данных

```sql
SELECT
    formatDateTime(transaction_date, '%Y-%m-%d') AS formattedDate,
    toYear(transaction_date) AS year,
    toMonth(transaction_date) AS month,
    toInt32(round(price, 0)) AS intPrice,
    toString(transaction_id) AS strTransactionID
FROM transactions
LIMIT 10

    ┌─formattedDate─┬─year─┬─month─┬─intPrice─┬─strTransactionID─┐
 1. │ 2024-04-29    │ 2024 │     4 │      375 │ 1                │
 2. │ 2025-01-28    │ 2025 │     1 │     1429 │ 2                │
 3. │ 2025-03-20    │ 2025 │     3 │     1498 │ 3                │
 4. │ 2025-01-25    │ 2025 │     1 │      869 │ 4                │
 5. │ 2025-01-21    │ 2025 │     1 │      423 │ 5                │
 6. │ 2024-12-28    │ 2024 │    12 │      531 │ 6                │
 7. │ 2025-04-05    │ 2025 │     4 │     1299 │ 7                │
 8. │ 2025-04-10    │ 2025 │     4 │     1036 │ 8                │
 9. │ 2024-12-24    │ 2024 │    12 │      697 │ 9                │
10. │ 2025-01-05    │ 2025 │     1 │      561 │ 10               │
    └───────────────┴──────┴───────┴──────────┴──────────────────┘
```

### User-Defined Functions (UDFs)

```sql
CREATE OR REPLACE FUNCTION `transaction$totalVolume` AS (p, q) -> (p * q)

CREATE OR REPLACE FUNCTION `transaction$category` AS (p, q, thr) -> if((p * q) > thr, 'big', 'small')

SELECT
    round(transaction$totalVolume(price, quantity), 2) AS total,
    transaction$category(price, quantity, 10000) AS category
FROM transactions
LIMIT 10

    ┌────total─┬─category─┐
 1. │   3754.1 │ small    │
 2. │   5716.4 │ small    │
 3. │   7488.2 │ small    │
 4. │  4346.45 │ small    │
 5. │  1267.65 │ small    │
 6. │  19130.4 │ big      │
 7. │  12988.8 │ big      │
 8. │  1035.77 │ small    │
 9. │  4877.39 │ small    │
10. │ 12902.08 │ big      │
    └──────────┴──────────┘
```

## **Вариант 2**

Вариант 2 реализован в ноутбуке [_Google Colab_](https://colab.research.google.com/drive/1a63ewUC8Jls6HpNXe6FGpeJDDIZYDLAl?usp=sharing).
