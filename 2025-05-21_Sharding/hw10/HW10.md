# [10] Шардирование

> Я работаю локально через [VirtualBox](https://www.virtualbox.org/) на Linux [CentOS 9](https://www.centos.org/stream9/). Процессы *ClickHouse* запускаются в [Docker](https://hub.docker.com/r/clickhouse/clickhouse-server/) контейнерах.

## Архитектура решения

В данном задании предлагается запустить *N* экземпляров *clickhouse-server*. Я решил использовать уже готовый [`docker-compose.yaml`](https://github.com/ClickHouse/examples/blob/5d56c8003b50a42a5cc58fdf9f8189b9cc148f1b/docker-compose-recipes/recipes/cluster_2S_2R/docker-compose.yaml) из примера [`cluster_2S_2R`](https://github.com/ClickHouse/examples/tree/main/docker-compose-recipes/recipes/cluster_2S_2R) в репозитории [`ClickHouse/examples`](https://github.com/ClickHouse/examples), с небольшими модификациями (номера портов и т.п.).

В примере запускается 4 экземпляра *clickhouse-server*, что как раз позволит настраивать на них разные топологии кластеров. Также запускаются 3 экземпляра *clickhouse-keeper* (в данной работе *clickhouse-keeper* нам не так важен).

<details>

<summary>docker-compose.yaml</summary>

```yaml
version: '3.8'
services:
  clickhouse-01:
    image: "clickhouse/clickhouse-server:${CHVER:-latest}"
    user: "101:101"
    container_name: clickhouse-01
    hostname: clickhouse-01
    volumes:
      - ${PWD}/fs/volumes/clickhouse-01/etc/clickhouse-server/config.d/config.xml:/etc/clickhouse-server/config.d/config.xml:Z
      - ${PWD}/fs/volumes/clickhouse-01/etc/clickhouse-server/users.d/users.xml:/etc/clickhouse-server/users.d/users.xml:Z
    ports:
      - "0.0.0.0:18123:8123"
      - "0.0.0.0:19000:9000"
    depends_on:
      - clickhouse-keeper-01
      - clickhouse-keeper-02
      - clickhouse-keeper-03
  clickhouse-02:
    image: "clickhouse/clickhouse-server:${CHVER:-latest}"
    user: "101:101"
    container_name: clickhouse-02
    hostname: clickhouse-02
    volumes:
      - ${PWD}/fs/volumes/clickhouse-02/etc/clickhouse-server/config.d/config.xml:/etc/clickhouse-server/config.d/config.xml:Z
      - ${PWD}/fs/volumes/clickhouse-02/etc/clickhouse-server/users.d/users.xml:/etc/clickhouse-server/users.d/users.xml:Z
    ports:
      - "0.0.0.0:28123:8123"
      - "0.0.0.0:29001:9000"
    depends_on:
      - clickhouse-keeper-01
      - clickhouse-keeper-02
      - clickhouse-keeper-03
  clickhouse-03:
    image: "clickhouse/clickhouse-server:${CHVER:-latest}"
    user: "101:101"
    container_name: clickhouse-03
    hostname: clickhouse-03
    volumes:
      - ${PWD}/fs/volumes/clickhouse-03/etc/clickhouse-server/config.d/config.xml:/etc/clickhouse-server/config.d/config.xml:Z
      - ${PWD}/fs/volumes/clickhouse-03/etc/clickhouse-server/users.d/users.xml:/etc/clickhouse-server/users.d/users.xml:Z
    ports:
      - "0.0.0.0:38123:8123"
      - "0.0.0.0:39002:9000"
    depends_on:
      - clickhouse-keeper-01
      - clickhouse-keeper-02
      - clickhouse-keeper-03
  clickhouse-04:
    image: "clickhouse/clickhouse-server:${CHVER:-latest}"
    user: "101:101"
    container_name: clickhouse-04
    hostname: clickhouse-04
    volumes:
      - ${PWD}/fs/volumes/clickhouse-04/etc/clickhouse-server/config.d/config.xml:/etc/clickhouse-server/config.d/config.xml:Z
      - ${PWD}/fs/volumes/clickhouse-04/etc/clickhouse-server/users.d/users.xml:/etc/clickhouse-server/users.d/users.xml:Z
    ports:
        - "0.0.0.0:48123:8123"
        - "0.0.0.0:49003:9000"
    depends_on:
      - clickhouse-keeper-01
      - clickhouse-keeper-02
      - clickhouse-keeper-03
  clickhouse-keeper-01:
    image: "clickhouse/clickhouse-keeper:${CHKVER:-latest-alpine}"
    user: "101:101"
    container_name: clickhouse-keeper-01
    hostname: clickhouse-keeper-01
    volumes:
     - ${PWD}/fs/volumes/clickhouse-keeper-01/etc/clickhouse-keeper/keeper_config.xml:/etc/clickhouse-keeper/keeper_config.xml:Z
    ports:
        - "0.0.0.0:9181:9181"
  clickhouse-keeper-02:
    image: "clickhouse/clickhouse-keeper:${CHKVER:-latest-alpine}"
    user: "101:101"
    container_name: clickhouse-keeper-02
    hostname: clickhouse-keeper-02
    volumes:
     - ${PWD}/fs/volumes/clickhouse-keeper-02/etc/clickhouse-keeper/keeper_config.xml:/etc/clickhouse-keeper/keeper_config.xml:Z
    ports:
        - "0.0.0.0:9182:9181"
  clickhouse-keeper-03:
    image: "clickhouse/clickhouse-keeper:${CHKVER:-latest-alpine}"
    user: "101:101"
    container_name: clickhouse-keeper-03
    hostname: clickhouse-keeper-03
    volumes:
     - ${PWD}/fs/volumes/clickhouse-keeper-03/etc/clickhouse-keeper/keeper_config.xml:/etc/clickhouse-keeper/keeper_config.xml:Z
    ports:
        - "0.0.0.0:9183:9181"
```

</details>

Запустим все контейнеры с нужными нам процессами с помощью команды `docker compose up -d`.

```shell
$ docker ps

CONTAINER ID  IMAGE                                                 COMMAND     CREATED             STATUS             PORTS                                                       NAMES
5d11021ab7e2  docker.io/clickhouse/clickhouse-keeper:latest-alpine              About a minute ago  Up About a minute  0.0.0.0:9181->9181/tcp, 2181/tcp, 10181/tcp, 44444/tcp      clickhouse-keeper-01
9bd0445b2765  docker.io/clickhouse/clickhouse-keeper:latest-alpine              About a minute ago  Up About a minute  0.0.0.0:9182->9181/tcp, 2181/tcp, 10181/tcp, 44444/tcp      clickhouse-keeper-02
2178074b0ffe  docker.io/clickhouse/clickhouse-keeper:latest-alpine              About a minute ago  Up About a minute  0.0.0.0:9183->9181/tcp, 2181/tcp, 10181/tcp, 44444/tcp      clickhouse-keeper-03
83e85301ae33  docker.io/clickhouse/clickhouse-server:latest                     About a minute ago  Up About a minute  0.0.0.0:18123->8123/tcp, 0.0.0.0:19000->9000/tcp, 9009/tcp  clickhouse-01
aec8b5451dab  docker.io/clickhouse/clickhouse-server:latest                     About a minute ago  Up About a minute  0.0.0.0:28123->8123/tcp, 0.0.0.0:29001->9000/tcp, 9009/tcp  clickhouse-02
6ddfe6c71cce  docker.io/clickhouse/clickhouse-server:latest                     About a minute ago  Up About a minute  0.0.0.0:38123->8123/tcp, 0.0.0.0:39002->9000/tcp, 9009/tcp  clickhouse-03
3b68359347a6  docker.io/clickhouse/clickhouse-server:latest                     About a minute ago  Up About a minute  0.0.0.0:48123->8123/tcp, 0.0.0.0:49003->9000/tcp, 9009/tcp  clickhouse-04
```

Для настройки различных топологий кластеров далее будем изменять *xml* файлы конфигурации четырёх серверов *ClickHouse*. Итоговое состояние конфигурации при необходимости можно посмотреть в текущем [репозитории](https://github.com/rklepov/OTUS-ClickHouse-2025-03/tree/main/2025-05-21_Sharding/hw10/cluster_2S_2R).

## Топология: 2 шарда, 2 реплики (2S_2R)

Собственно, это оригинальная топология из примера `cluster_2S_2R` (изображение скопировано из видео-урока [ClickHouse at Scale](https://www.youtube.com/embed/vBjCJtw_Ei0?si=eu_5JqGJBnZWNN2J")):

![cluster_2S_2R][cluster_2S_2R]

### [2S_2R] Кластер

```xml
    <remote_servers>
        <cluster_2S_2R>
            <shard>
                <internal_replication>true</internal_replication>
                <replica>
                    <host>clickhouse-01</host>
                    <port>9000</port>
                </replica>
                <replica>
                    <host>clickhouse-03</host>
                    <port>9000</port>
                </replica>
            </shard>
            <shard>
                <internal_replication>true</internal_replication>
                <replica>
                    <host>clickhouse-02</host>
                    <port>9000</port>
                </replica>
                <replica>
                    <host>clickhouse-04</host>
                    <port>9000</port>
                </replica>
            </shard>
        </cluster_2S_2R>
    </remote_servers>
```

Запрос состояния кластера:

```sql
SELECT
    cluster,
    shard_num,
    replica_num,
    host_name,
    is_local
FROM system.clusters
WHERE cluster IN ('cluster_2S_2R')

   ┌─cluster───────┬─shard_num─┬─replica_num─┬─host_name─────┬─is_local─┐
1. │ cluster_2S_2R │         1 │           1 │ clickhouse-01 │        1 │
2. │ cluster_2S_2R │         1 │           2 │ clickhouse-03 │        0 │
3. │ cluster_2S_2R │         2 │           1 │ clickhouse-02 │        0 │
4. │ cluster_2S_2R │         2 │           2 │ clickhouse-04 │        0 │
   └───────────────┴───────────┴─────────────┴───────────────┴──────────┘

4 rows in set. Elapsed: 0.007 sec.

```

### [2S_2R] Распределённая таблица

Да простоты, как и рекомендуется в задании, в качестве локальной таблицы будем использовать [*system.one*](https://clickhouse.com/docs/operations/system-tables/one).

```sql
CREATE DATABASE IF NOT EXISTS hw10 ON CLUSTER cluster_2S_2R

   ┌─host──────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ clickhouse-01 │ 9000 │      0 │       │                   3 │                0 │
2. │ clickhouse-02 │ 9000 │      0 │       │                   2 │                0 │
3. │ clickhouse-04 │ 9000 │      0 │       │                   1 │                0 │
4. │ clickhouse-03 │ 9000 │      0 │       │                   0 │                0 │
   └───────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.115 sec.


CREATE TABLE hw10.t_cluster_2S_2R ON CLUSTER cluster_2S_2R AS system.one
ENGINE = Distributed('cluster_2S_2R', 'system', 'one', rand())

   ┌─host──────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ clickhouse-02 │ 9000 │      0 │       │                   3 │                0 │
2. │ clickhouse-01 │ 9000 │      0 │       │                   2 │                0 │
3. │ clickhouse-04 │ 9000 │      0 │       │                   1 │                0 │
4. │ clickhouse-03 │ 9000 │      0 │       │                   0 │                0 │
   └───────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.118 sec.
```

Проверяем таблицу:

```sql
SHOW CREATE TABLE hw10.t_cluster_2S_2R
FORMAT Raw

CREATE TABLE hw10.t_cluster_2S_2R
(
    `dummy` UInt8
)
ENGINE = Distributed('cluster_2S_2R', 'system', 'one', rand())
COMMENT 'This table contains a single row with a single dummy UInt8 column containing the value 0. Used when the table is not specified explicitly, for example in queries like `SELECT 1`.'

1 row in set. Elapsed: 0.002 sec.
```

Запрос на распределённую таблицу:

```sql
SELECT
    *,
    hostName(),
    _shard_num
FROM hw10.t_cluster_2S_2R

   ┌─dummy─┬─hostName()────┬─_shard_num─┐
1. │     0 │ clickhouse-01 │          1 │
2. │     0 │ clickhouse-04 │          2 │
   └───────┴───────────────┴────────────┘

2 rows in set. Elapsed: 0.030 sec.
```

[cluster_2S_2R]: https://github.com/rklepov/OTUS-ClickHouse-2025-03/blob/main/2025-05-21_Sharding/hw10/cluster_2S_2R.png

## Топология: 1 шард, 3 реплики (1S_3R)

Эта топология подходит для варианта, когда мы храним относительно небольшой объём данных и при этом существуют повышенные требования к отказоустойчивости. В данном случае сервер **clickhouse-04** не используется (это было бы уже слишком избыточно).

### [1S_3R] Кластер

```xml
    <remote_servers>
        <cluster_1S_3R>
            <shard>
                <internal_replication>true</internal_replication>
                <replica>
                    <host>clickhouse-01</host>
                    <port>9000</port>
                </replica>
                <replica>
                    <host>clickhouse-02</host>
                    <port>9000</port>
                </replica>
                <replica>
                    <host>clickhouse-03</host>
                    <port>9000</port>
                </replica>
            </shard>
        </cluster_1S_3R>
    </remote_servers>
```

Запрос состояния кластера:

```sql
SELECT
    cluster,
    shard_num,
    replica_num,
    host_name,
    is_local
FROM system.clusters
WHERE cluster IN ('cluster_1S_3R')

   ┌─cluster───────┬─shard_num─┬─replica_num─┬─host_name─────┬─is_local─┐
1. │ cluster_1S_3R │         1 │           1 │ clickhouse-01 │        1 │
2. │ cluster_1S_3R │         1 │           2 │ clickhouse-02 │        0 │
3. │ cluster_1S_3R │         1 │           3 │ clickhouse-03 │        0 │
   └───────────────┴───────────┴─────────────┴───────────────┴──────────┘

3 rows in set. Elapsed: 0.004 sec.
```

### [1S_3R] Распределённая таблица

> В данном случае *распределённая* таблица не имеет смысла, потому что шард только один. Но, для единообразия в примерах, мы её здесь тоже создадим.

В качестве локальной таблицы также будем использовать *system.one*.

```sql
CREATE DATABASE IF NOT EXISTS hw10 ON CLUSTER cluster_1S_3R

   ┌─host──────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ clickhouse-02 │ 9000 │      0 │       │                   2 │                0 │
2. │ clickhouse-03 │ 9000 │      0 │       │                   1 │                0 │
3. │ clickhouse-01 │ 9000 │      0 │       │                   0 │                0 │
   └───────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

3 rows in set. Elapsed: 0.120 sec.


CREATE TABLE hw10.t_cluster_1S_3R ON CLUSTER cluster_1S_3R AS system.one
ENGINE = Distributed('cluster_1S_3R', 'system', 'one', rand())

   ┌─host──────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ clickhouse-02 │ 9000 │      0 │       │                   2 │                0 │
2. │ clickhouse-03 │ 9000 │      0 │       │                   1 │                0 │
3. │ clickhouse-01 │ 9000 │      0 │       │                   0 │                0 │
   └───────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

3 rows in set. Elapsed: 0.100 sec.
```

Проверяем таблицу:

```sql
SHOW CREATE TABLE hw10.t_cluster_1S_3R
FORMAT Raw

CREATE TABLE hw10.t_cluster_1S_3R
(
    `dummy` UInt8
)
ENGINE = Distributed('cluster_1S_3R', 'system', 'one', rand())
COMMENT 'This table contains a single row with a single dummy UInt8 column containing the value 0. Used when the table is not specified explicitly, for example in queries like `SELECT 1`.'

1 row in set. Elapsed: 0.003 sec.
```

Запрос на распределённую таблицу выполним на *втором* сервере:

```sql
SELECT
    *,
    hostName(),
    _shard_num
FROM hw10.t_cluster_1S_3R

   ┌─dummy─┬─hostName()────┬─_shard_num─┐
1. │     0 │ clickhouse-02 │          1 │
   └───────┴───────────────┴────────────┘

1 row in set. Elapsed: 0.005 sec.
```

## Топология: 4 шарда, 1 реплика (4S_1R)

Эта топология подходит в случае, если у нас есть много некритичных данных и требуется высокая пропускная способность.

### [4S_1R] Кластер

```xml
    <remote_servers>
        <cluster_4S_1R>
            <shard>
                <internal_replication>true</internal_replication>
                <replica>
                    <host>clickhouse-01</host>
                    <port>9000</port>
                </replica>
            </shard>
            <shard>
                <internal_replication>true</internal_replication>
                <replica>
                    <host>clickhouse-02</host>
                    <port>9000</port>
                </replica>
            </shard>
            <shard>
                <internal_replication>true</internal_replication>
                <replica>
                    <host>clickhouse-03</host>
                    <port>9000</port>
                </replica>
            </shard>
            <shard>
                <internal_replication>true</internal_replication>
                <replica>
                    <host>clickhouse-04</host>
                    <port>9000</port>
                </replica>
            </shard>
        </cluster_4S_1R>
    </remote_servers>
```

Запрос состояния кластера:

```sql
SELECT
    cluster,
    shard_num,
    replica_num,
    host_name,
    is_local
FROM system.clusters
WHERE cluster IN ('cluster_4S_1R')

   ┌─cluster───────┬─shard_num─┬─replica_num─┬─host_name─────┬─is_local─┐
1. │ cluster_4S_1R │         1 │           1 │ clickhouse-01 │        0 │
2. │ cluster_4S_1R │         2 │           1 │ clickhouse-02 │        1 │
3. │ cluster_4S_1R │         3 │           1 │ clickhouse-03 │        0 │
4. │ cluster_4S_1R │         4 │           1 │ clickhouse-04 │        0 │
   └───────────────┴───────────┴─────────────┴───────────────┴──────────┘

4 rows in set. Elapsed: 0.004 sec.
```

### [4S_1R] Распределённая таблица

В качестве локальной таблицы опять будем использовать *system.one*.

```sql
CREATE DATABASE IF NOT EXISTS hw10 ON CLUSTER cluster_4S_1R

   ┌─host──────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ clickhouse-01 │ 9000 │      0 │       │                   3 │                0 │
2. │ clickhouse-04 │ 9000 │      0 │       │                   2 │                0 │
3. │ clickhouse-03 │ 9000 │      0 │       │                   1 │                0 │
4. │ clickhouse-02 │ 9000 │      0 │       │                   0 │                0 │
   └───────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.131 sec.


CREATE TABLE hw10.t_cluster_4S_1R ON CLUSTER cluster_4S_1R AS system.one
ENGINE = Distributed('cluster_4S_1R', 'system', 'one', rand())

   ┌─host──────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ clickhouse-04 │ 9000 │      0 │       │                   3 │                0 │
2. │ clickhouse-01 │ 9000 │      0 │       │                   2 │                0 │
3. │ clickhouse-03 │ 9000 │      0 │       │                   1 │                0 │
4. │ clickhouse-02 │ 9000 │      0 │       │                   0 │                0 │
   └───────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.108 sec.
```

Проверяем таблицу:

```sql
SHOW CREATE TABLE hw10.t_cluster_4S_1R
FORMAT Raw

CREATE TABLE hw10.t_cluster_4S_1R
(
    `dummy` UInt8
)
ENGINE = Distributed('cluster_4S_1R', 'system', 'one', rand())
COMMENT 'This table contains a single row with a single dummy UInt8 column containing the value 0. Used when the table is not specified explicitly, for example in queries like `SELECT 1`.'

1 row in set. Elapsed: 0.002 sec.
```

Запрос на распределённую таблицу:

```sql
SELECT
    *,
    hostName(),
    _shard_num
FROM hw10.t_cluster_4S_1R

   ┌─dummy─┬─hostName()────┬─_shard_num─┐
1. │     0 │ clickhouse-02 │          2 │
2. │     0 │ clickhouse-04 │          4 │
3. │     0 │ clickhouse-03 │          3 │
4. │     0 │ clickhouse-01 │          1 │
   └───────┴───────────────┴────────────┘

4 rows in set. Elapsed: 0.039 sec.
```
