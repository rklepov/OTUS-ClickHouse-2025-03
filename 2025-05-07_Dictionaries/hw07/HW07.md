# [07] Словари

## Таблица

Создаём простую *in-memory* таблицу со схемой из задания:

```sql
CREATE OR REPLACE TABLE user_actions
(
    `user_id` UInt64,
    `action` String,
    `expense` UInt64
)
ENGINE = Memory

0 rows in set. Elapsed: 0.023 sec.
```

Заполняем рандомизированными данными:

```sql
INSERT INTO user_actions WITH ['GET', 'DELETE', 'PATCH', 'POST', 'PUT', 'UPDATE'] AS a
SELECT
    1 + (rand64() % 5) AS user_id,
    a[1 + (rand() % length(a))] AS action,
    1 + (rand64() % 10000) AS expense
FROM numbers(30)

0 rows in set. Elapsed: 0.006 sec.
```

Значения поля **action** &mdash; низкокардинальные (выбираются из ограниченного множества). Для каждого **user_id** существует более одной записи.

```sql
SELECT
    user_id,
    count() AS cnt
FROM user_actions
GROUP BY user_id
ORDER BY user_id ASC

   ┌─user_id─┬─cnt─┐
1. │       1 │   7 │
2. │       2 │   4 │
3. │       3 │  11 │
4. │       4 │   3 │
5. │       5 │   5 │
   └─────────┴─────┘

5 rows in set. Elapsed: 0.003 sec.
```

## Словарь

В качестве источника словаря будем использовать файл в формате `csv` со строкой заголовка. Файл должен быть расположен в подкаталоге [`user_files`](https://clickhouse.com/docs/sql-reference/dictionaries#local-file). Создаём словарь с отображением ста ключей **user_id** на **email** (для наглядности соответствие сделано очевидным).

```shell
root@1338e36c1929:~# cd /var/lib/clickhouse

root@1338e36c1929:/var/lib/clickhouse# echo user_id,email > user_files/emails.csv

root@1338e36c1929:/var/lib/clickhouse# seq 100 | xargs -I%% printf '%d,user%03d@email.com\n' %% %% >> user_files/emails.csv

root@1338e36c1929:/var/lib/clickhouse# cat user_files/emails.csv | head -10
user_id,email
1,user001@email.com
2,user002@email.com
3,user003@email.com
4,user004@email.com
5,user005@email.com
6,user006@email.com
7,user007@email.com
8,user008@email.com
9,user009@email.com
```

Создаём [словарь](https://clickhouse.com/blog/faster-queries-dictionaries-clickhouse) в **ClickHouse**:

```sql
CREATE DICTIONARY user_emails
(
    `user_id` UInt64,
    `email` String
)
PRIMARY KEY user_id
SOURCE(FILE(PATH './user_files/emails.csv' FORMAT 'CSVWithNames'))
LIFETIME(MIN 0 MAX 0)
LAYOUT(FLAT)

0 rows in set. Elapsed: 0.018 sec.
```

Проверяем, что удалось успешно подключиться к данным из источника:

```sql
SELECT *
FROM user_emails
LIMIT 10

    ┌─user_id─┬─email─────────────┐
 1. │       1 │ user001@email.com │
 2. │       2 │ user002@email.com │
 3. │       3 │ user003@email.com │
 4. │       4 │ user004@email.com │
 5. │       5 │ user005@email.com │
 6. │       6 │ user006@email.com │
 7. │       7 │ user007@email.com │
 8. │       8 │ user008@email.com │
 9. │       9 │ user009@email.com │
10. │      10 │ user010@email.com │
    └─────────┴───────────────────┘

10 rows in set. Elapsed: 0.002 sec.
```

## Запрос

Следующий запрос извлекает **email** из словаря, а также считает накопительную сумму по полю **expense** для каждого вида **action**. Сумма накапливается в порядке сортировки **email** (в данном случае он же соответствует порядку **user_id**). Для наглядности также выводим *фрейм*, по которому производится суммирование.

> Чтобы записи с одинаковыми комбинациями пар **action** + **email** не попали в один фрейм используем вспомогательную функцию [`rowNumberInAllBlocks`](https://clickhouse.com/docs/sql-reference/functions/other-functions#rownumberinallblocks), которая позволяет сделать такую запись уникальной.

```sql
SELECT
    user_id,
    dictGet('user_emails', 'email', user_id) AS email,
    action,
    expense,
    sum(expense) OVER (w) AS sum_expense,
    groupArray(expense) OVER (w) AS frame_expense
FROM user_actions
WINDOW w AS (PARTITION BY action ORDER BY email ASC, rowNumberInAllBlocks() ASC)

    ┌─user_id─┬─email─────────────┬─action─┬─expense─┬─sum_expense─┬─frame_expense────────────────────────────────┐
 1. │       2 │ user002@email.com │ DELETE │    9517 │        9517 │ [9517]                                       │
 2. │       3 │ user003@email.com │ DELETE │    2663 │       12180 │ [9517,2663]                                  │
 3. │       3 │ user003@email.com │ DELETE │    7423 │       19603 │ [9517,2663,7423]                             │
 4. │       5 │ user005@email.com │ DELETE │    9190 │       28793 │ [9517,2663,7423,9190]                        │
 5. │       1 │ user001@email.com │ GET    │    8551 │        8551 │ [8551]                                       │
 6. │       1 │ user001@email.com │ GET    │    7216 │       15767 │ [8551,7216]                                  │
 7. │       2 │ user002@email.com │ GET    │    9547 │       25314 │ [8551,7216,9547]                             │
 8. │       2 │ user002@email.com │ GET    │    7652 │       32966 │ [8551,7216,9547,7652]                        │
 9. │       3 │ user003@email.com │ GET    │    1368 │       34334 │ [8551,7216,9547,7652,1368]                   │
10. │       3 │ user003@email.com │ GET    │     468 │       34802 │ [8551,7216,9547,7652,1368,468]               │
11. │       3 │ user003@email.com │ GET    │     423 │       35225 │ [8551,7216,9547,7652,1368,468,423]           │
12. │       4 │ user004@email.com │ GET    │    3204 │       38429 │ [8551,7216,9547,7652,1368,468,423,3204]      │
13. │       5 │ user005@email.com │ GET    │    4050 │       42479 │ [8551,7216,9547,7652,1368,468,423,3204,4050] │
14. │       1 │ user001@email.com │ PATCH  │    7526 │        7526 │ [7526]                                       │
15. │       3 │ user003@email.com │ PATCH  │    1708 │        9234 │ [7526,1708]                                  │
16. │       4 │ user004@email.com │ PATCH  │    4689 │       13923 │ [7526,1708,4689]                             │
17. │       5 │ user005@email.com │ PATCH  │    8230 │       22153 │ [7526,1708,4689,8230]                        │
18. │       1 │ user001@email.com │ POST   │    8271 │        8271 │ [8271]                                       │
19. │       3 │ user003@email.com │ POST   │    2073 │       10344 │ [8271,2073]                                  │
20. │       3 │ user003@email.com │ POST   │    7558 │       17902 │ [8271,2073,7558]                             │
21. │       4 │ user004@email.com │ POST   │     874 │       18776 │ [8271,2073,7558,874]                         │
22. │       5 │ user005@email.com │ POST   │    1530 │       20306 │ [8271,2073,7558,874,1530]                    │
23. │       2 │ user002@email.com │ PUT    │    3872 │        3872 │ [3872]                                       │
24. │       3 │ user003@email.com │ PUT    │     593 │        4465 │ [3872,593]                                   │
25. │       3 │ user003@email.com │ PUT    │      18 │        4483 │ [3872,593,18]                                │
26. │       5 │ user005@email.com │ PUT    │    8315 │       12798 │ [3872,593,18,8315]                           │
27. │       1 │ user001@email.com │ UPDATE │    2226 │        2226 │ [2226]                                       │
28. │       1 │ user001@email.com │ UPDATE │    7806 │       10032 │ [2226,7806]                                  │
29. │       1 │ user001@email.com │ UPDATE │    9016 │       19048 │ [2226,7806,9016]                             │
30. │       3 │ user003@email.com │ UPDATE │    4098 │       23146 │ [2226,7806,9016,4098]                        │
    └─────────┴───────────────────┴────────┴─────────┴─────────────┴──────────────────────────────────────────────┘

30 rows in set. Elapsed: 0.006 sec.
```
