# [01] Адаптация ClickHouse

## Примеры использования _ClickHouse_ в компаниях на рынке

Примеры взяты со страниц [ClickHouse Adopters](https://clickhouse.com/docs/about-us/adopters) и [ClickHouse Blog](https://clickhouse.com/blog).

### 1. **Deutsche Bank** ([Meetup Video, December 2022](https://www.youtube.com/watch?v=O3GJ6jag3Hc&list=PL0Z2YDlm0b3iNDUzpY1S3L_iV4nARda_U&index=11))

_ClickHouse_ используется с 2017г. Хранятся десятки разнородных датасетов c финансовыми данными (сделки, котировки, рыночные данные и т.п.). Объем данных исчисляется сотнями терабайт.

#### Особенности

##### Кастомная система контроля доступа

Значительная часть данных является чувствительной (_sensitive_). Базовых средств безопасности _ClickHouse_ оказалось недостаточно. Все запросы проходят через _proxy_, который динамически изменяет фильтр запроса в соответствии с уровнем доступа пользователя, выполняющего запрос.

##### Географически распределённый кластер _ClickHouse_

В связи с законодательством разных стран о _data locality_ приходится учитывать локацию как пользователя, так и запрашиваемых данных, и прозрачным для пользователя образом динамически модифицировать запрос, чтобы ограничивать доступ к данным.

### 2. **Longbridge Technology**, a fintech company ([ClickHouse blog, March 2025](https://clickhouse.com/blog/longbridge-technology-simplifies-their-architecture-and-achieves-10x-performance-boost-with-clickhouse))

Платформа обеспечивает _real-time_ доступ к рыночным данным по разным типам финансовых активов. Новые данные появляются с частотой порядка нескольких миллионов записей в секунду. Требуются эффективные запросы на исторических данных с агрегациями разного вида.

#### Внедрение

Мигрировали с оригинальной сложной архитектуры (_PostgreSQL_ + _Redis_ + _DynamoDB_) на _ClickHouse_. Система развёрнута на облачном решении [Alibaba cloud](https://www.alibabacloud.com/) (сама компания работает в Сингапуре и Гонконге). Интерфейс к [s3](https://clickhouse.com/docs/sql-reference/table-functions/s3) позволил провести прозрачную миграцию данных.

#### Архитектура

- Унифицированное хранилище для рыночных данных из разных источников.
- Для _intra-day_ данных используется гибридное решение _Redis + ClickHouse_.
- Коэффициент компрессии данных увеличился до 5 раз, таким образом позволив сократить затраты на дисковое пространство в облаке.
- Существенно сократилась сложность запросов: ранее надо было запрашивать данные из 128 таблиц _PostgreSQL_ и проводить статистические вычисления на стороне клиента. Сейчас запрос идёт в единственную таблицу _ClickHouse_ и используются встроенные функции агрегации.

### 3. **Skool** community platform ([SoCal Meetup slides, August 2024](https://github.com/user-attachments/files/17081161/ClickHouse.Meetup.pptx))

_ClickHouse_ используется как платформа для анализа поведения пользователей, анализа результатов экспериментов с новыми функциями системы ([GrowthBook](https://docs.growthbook.io/warehouses/clickhouse)), а также наблюдения за состоянием системы ([Grafana](https://clickhouse.com/docs/integrations/grafana)). Более 100M новых записей в день. Мигрировали аналитическую платформу с _PostgreSQL_ на _ClickHouse_ (транзакционные данные по-прежнему в _PostgreSQL_). Удалось снизить среднее время аналитических запросов с минут (_PostgreSQL_) до секунд (_ClickHouse_). Система развёрнута в _ClickHouse cloud_.

## Дополнительное задание

**Q:** _К каким классам систем относится ClickHouse?_<br/>
**A:** _ClickHouse_ относится к [OLAP](https://double.cloud/blog/posts/2022/09/what-is-clickhouse-why-column-oriented-dbms-are-important/) СУБД

**Q:** _Какую проблему вы бы решили используя ClickHouse, а какую бы не стали?_<br/>
**A:** _ClickHouse_ хорошо подходит для обработки аналитических запросов, то есть для задач, в которых требуется агрегация данных из отдельных колонок больших датасетов. Однако как раз колоночно-ориентированная архитектура делает его плохо пригодным для типичных задач [OLTP](https://www.ibm.com/think/topics/oltp). Таким образом, вряд ли стоит выбирать _ClickHouse_ для задач, в которых:

- требуется, собственно говоря, поддержка транзакций,
- происходят частые запросы на изменение (_UPDATE_) и удаление (_DELETE_) конкретных записей в таблице,
- требуется работа сразу со всеми полями записи (то есть одновременно со всеми файлами колонок),
- приходит множество запросов на получение значений из полей конкретных записей в таблице (в отличие от агрегированных величин),
- часто происходят запросы с _JOIN_ нескольких таблиц (при этом необходимо отметить, что в _ClickHouse_ есть полноценная поддержка [_JOIN_](https://clickhouse.com/blog/clickhouse-fully-supports-joins-part1)),
- требуется _key-value_ storage (есть более специализированные СУБД).

**Q:** _Где можно получить помощь по ClickHouse и куда сообщать о багах?_<br/>
**A:** Неполный список ресурсов:

- Документация на сайте [clickhouse.com](https://clickhouse.com/docs/introduction-clickhouse)
- _Tg_ канал <https://t.me/clickhouse_ru>
- Репозиторий _ClickHouse_ на [github.com](https://github.com/ClickHouse/ClickHouse/issues)
